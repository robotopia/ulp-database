{% extends "published/main.html" %}

{% load static %}

{% block body %}

<h1>{{ ulp }}</h1>

<label for="folding_period_select" class="form-label">Reset folding period to:</label>
<select id="folding_period_select" class="form-control" name="folding_period">
  {% for period in periods %}
  <option value="{{ period.quantity }}">{{ period.formatted_quantity_with_units }}</option>
  {% endfor %}
</select>

<label for="pepoch" class="form-label">PEPOCH:</label>
<input type="number" class="form-control" id="pepoch" value="{{ toas.0.mjd }}" onchange="replot()"/>

<label for="folding-period" class="form-label">Folding period:</label>
<input type="number" class="form-control" id="folding-period" value="{{ init_folding_period }}" onchange="replot()"/>

<input type="number" id="xmin" value="{{ plot_specs.xmin }}" onchange="replot()" hidden/>
<input type="number" id="xmax" value="{{ plot_specs.xmax }}" onchange="replot()" hidden/>
<input type="number" id="ymin" value="-0.5" onchange="replot()" hidden/>
<input type="number" id="ymax" value="0.5" onchange="replot()" hidden/>

<div id="residual-plot" style="height: 500px;"></div>

<div id="instructions">
  <h2>Usage</h2>
  ...
</div>

<script src="https://d3js.org/d3.v4.js"></script>
<script type="text/javascript" src="{% static 'data/residual_plot.js' %}"></script>
<script>

  // Get the data for the plot
  var plot_data = {{ toas | safe }};

  // Get the folding period and the PEPOCH
  const folding_period_element = document.getElementById("folding-period")
  const pepoch_element = document.getElementById("pepoch")

  var xmin_element = document.getElementById("xmin")
  var xmax_element = document.getElementById("xmax")
  var ymin_element = document.getElementById("ymin")
  var ymax_element = document.getElementById("ymax")

  var xlim = [xmin_element.value, xmax_element.value];
  var ylim = [ymin_element.value, ymax_element.value];

  // set the dimensions and margins of the graph
  var parentDiv = document.getElementById("residual-plot");

  // Create plot elements
  plot = create_residual_plot_elements("residual-plot");

  // "g" is the main group containing all plotted elements
  var margin = {top: 50, right: 80, bottom: 50, left: 80};
  var folding_period = folding_period_element.value;
  var pepoch = pepoch_element.value;
  ephemeris = {
    folding_period: folding_period_element.value,
    pepoch: pepoch_element.value
  };
  set_residual_plot_dimensions(plot, xlim, ylim, margin, ephemeris);

  function plot_dataset(data, color) {

    // Get the folding period and the PEPOCH
    var folding_period = folding_period_element.value;
    var pepoch = pepoch_element.value;
    var ephemeris = {
      folding_period: folding_period_element.value,
      pepoch: pepoch_element.value
    };

    // Remove previous points
    plot.g.selectAll('.data').remove();

    // Add points
    add_residual_data(plot, data, color);
    position_residual_data(plot, ephemeris);

  }

  function replot() {
    plot_dataset(plot_data, "#d090f8");
  }

  // Zoom on mouse wheel
  plot.svg.on("wheel", function(d) {
    xmin = parseFloat(xmin_element.value);
    xmax = parseFloat(xmax_element.value);
    ymin = parseFloat(ymin_element.value);
    ymax = parseFloat(ymax_element.value);

    m = d3.mouse(this);
    xpos = plot.x.invert(m[0] - margin.left);
    ypos = plot.y.invert(m[1] - margin.top);

    scale_factor = d3.event.wheelDelta < 0 ? 0.05 : -0.05;

    if (xpos > xmin && xpos < xmax) { // if mouse is not over the y-axis itself (if it were, we leave x-zoom untouched)
      xmin -= scale_factor*(xpos - xmin);
      xmax += scale_factor*(xmax - xpos);
      xmin_element.value = xmin;
      xmax_element.value = xmax;
    }

    if (ypos > ymin && ypos < ymax) { // if mouse is not over the x-axis itself (if it were, we leave y-zoom untouched)
      ymin -= scale_factor*(ypos - ymin);
      ymax += scale_factor*(ymax - ypos);
      ymin_element.value = ymin;
      ymax_element.value = ymax;
    }

    let xlim = [xmin, xmax];
    let ylim = [ymin, ymax];

    var ephemeris = {
      folding_period: folding_period_element.value,
      pepoch: pepoch_element.value
    };
    set_residual_plot_dimensions(plot, xlim, ylim, margin, ephemeris);
    position_residual_data(plot, ephemeris);
  });

  // A handy function for plotting the period path
  function myLine(svg, path, pos) {

    // Draw the svg line from the origin to the clicked point
    // Everything here in "g" coords
    pos[0] -= margin.left; // (Now converted to "g" coords)
    pos[1] -= margin.top;
    let origpos = [plot.x2(0), plot.y(0)];
    let slope = (pos[1] - origpos[1]) / (pos[0] - origpos[0]);
    let yintercept = pos[1] - slope*pos[0];

    // Draw the path connecting the clicked point and the origin
    plot.period_path
      .attr("d", "M 0," + yintercept + " L " + plot.width + "," + (slope*plot.width + yintercept))
      .style("stroke-opacity", "0.5");

  }

  // Change period on mouse drag
  mousedown = false;
  plot.svg.on("mousedown", function() {
    // Record in global variable the fact that the mouse button is down
    mousedown = true;
    ref_factor = null;
  });

  plot.svg.on("mousemove", function() {
    if (mousedown) {
      d3.event.preventDefault();

      // Draw the svg line from the origin to the clicked point
      let movepos = d3.mouse(this);

      var pepoch = pepoch_element.value;
      var folding_period = folding_period_element.value;

      // Record for later use the world coords of the clicked event, as well as the folding period
      let mjd = plot.x.invert(movepos[0] - margin.left) - pepoch; // world coords of click pos
      let res = plot.y2.invert(movepos[1] - margin.top);          // world coords of click pos
      factor = res / (mjd*86400);

      if (ref_factor !== null) {
        folding_period *= (1 - (factor - ref_factor));
        folding_period_element.value = folding_period; // Put the new value in the field
        var ephemeris = {
          folding_period: folding_period_element.value,
          pepoch: pepoch_element.value
        };
        // Update plot
        position_residual_data(plot, ephemeris);
      }
      ref_factor = factor;


      myLine(plot.svg, plot.period_path, movepos);
    }
  });

  plot.svg.on("mouseup", function() {
    mousedown = false;

    plot.period_path
      .style("stroke-opacity", "0.0")

  });

  // Plot once to get started
  add_residual_data(plot, plot_data, "#d090f8");
  position_residual_data(plot, ephemeris);

</script>

{% endblock %}
