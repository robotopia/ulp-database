{% extends "published/main.html" %}

{% load static %}

{% block body %}

<h1>{{ ulp }}</h1>

<label for="folding_period_select" class="form-label">Reset folding period to:</label>
<select id="folding_period_select" class="form-control" name="folding_period">
  {% for period in periods %}
  <option value="{{ period.quantity }}">{{ period.formatted_quantity_with_units }}</option>
  {% endfor %}
</select>

<label for="pepoch" class="form-label">PEPOCH:</label>
<input type="number" class="form-control" id="pepoch" value="{{ pepoch.mjd }}" onchange="replot()"/>

<label for="folding-period" class="form-label">Folding period:</label>
<input type="number" class="form-control" id="folding-period" value="{{ init_folding_period }}" onchange="replot()"/>

<div id="residual-plot" style="height: 500px;"></div>

<div id="instructions">
  <h2>Usage</h2>
  ...
</div>

<script src="https://d3js.org/d3.v4.js"></script>
<script type="text/javascript" src="{% static 'data/residual_plot.js' %}"></script>
<script>

  // Get the folding period and the PEPOCH
  const folding_period_element = document.getElementById("folding-period")
  const pepoch_element = document.getElementById("pepoch")

  // set the dimensions and margins of the graph
  var parentDiv = document.getElementById("residual-plot");

  // Create plot elements
  plot = create_residual_plot_elements("residual-plot");

  // "g" is the main group containing all plotted elements
  var margin = {top: 50, right: 80, bottom: 50, left: 80};
  var folding_period = folding_period_element.value;
  var pepoch = pepoch_element.value;
  ephemeris = {
    folding_period: folding_period_element.value,
    pepoch: pepoch_element.value
  };

  var xlim = [{{ plot_specs.xmin }}, {{ plot_specs.xmax }}];
  var ylim = [-0.5, 0.5];

  set_residual_plot_dimensions(plot, xlim, ylim, margin, ephemeris);

  function replot() {
    position_residual_data(plot, ephemeris);
  }

  // Zoom on mouse wheel
  plot.svg.on("wheel", function(d) {

    scrollpos = d3.mouse(this);

    var ephemeris = {
      folding_period: folding_period_element.value,
      pepoch: pepoch_element.value
    };

    plot_zoom(plot, scrollpos, ephemeris);
  });

  // Change period on mouse drag
  plot.svg.on("mousedown", edit_period_mousedown);

  plot.svg.on("mousemove", function() {
    if (svg_mousedown) {
      d3.event.preventDefault();

      let movepos = d3.mouse(this);

      var ephemeris = {
        folding_period: folding_period_element.value,
        pepoch: pepoch_element.value
      };
      edit_period_mousemove(plot, ephemeris, movepos);

      // Change the value in the input field
      folding_period_element.value = ephemeris.folding_period;
    }
  });

  plot.svg.on("mouseup", function() {
    edit_period_mouseup(plot);
  });

  // Plot once to get started
  add_residual_data(plot, "{% url 'toa_data' pk=ulp.pk %}", "#d090f8", ephemeris);

</script>

{% endblock %}
