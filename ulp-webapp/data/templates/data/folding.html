{% extends "published/main.html" %}

{% load static %}

{% block body %}

<h1>Folding on {{ ulp }}</h1>

<form method="post" action="{% url 'folding_view' pk=ulp.pk %}">
  {% csrf_token %}
  <div class="compact-form-item">
    <label for="pepoch">PEPOCH (MJD)</label>
    <input id="pepoch" name="pepoch" type="number" step="any" value="{{ working_ephemeris.pepoch|default_if_none:'' }}"/>
  </div>
  <div class="compact-form-item">
    <label for="p0">Rotational period (s)</label>
    <input id="p0" name="p0" type="number" step="any" value="{{ working_ephemeris.p0|default_if_none:'' }}"/>
  </div>
  <div class="compact-form-item">
    <label for="p1">Rotational period derivative (s/s)</label>
    <input id="p1" name="p1" type="number" step="any" value="{{ working_ephemeris.p1|default_if_none:'' }}"/>
  </div>
  <div class="compact-form-item">
    <label for="pb">Orbital period (h)</label>
    <input id="pb" name="pb" type="number" step="any" value="{{ working_ephemeris.pb|default_if_none:'' }}"/>
  </div>
  <div class="compact-form-item">
    <label for="dm">Dispersion measure (pc/cm^3)</label>
    <input id="dm" name="dm" type="number" step="any" value="{{ working_ephemeris.dm|default_if_none:'' }}"/>
  </div>
  <input type="submit" value="Update"/>
</form>

<h2>Pulsestack</h2>

<fieldset>
  <legend>Element visibility</legend>

  <input type="checkbox" id="lc_visible" checked onchange="toggle_lightcurve_visibility(this);"/>
  <label for="lc_visible">Lightcurves</label>

  <input type="checkbox" id="pulses_visible" onchange="toggle_pulses_visibility(this);"/>
  <label for="pulses_visible">Pulses</label>
</fieldset>

<div id='pulsestack'>
</div>

<script>

  function prepare_data(data, pepoch, period) {
    return data.map((d) => {
      phases = fold(d.mjds, pepoch, period).phases;
      return {
        t0: d.t0,
        x: phases,
        y: d.values,
        mode: 'lines+markers',
        type: 'scatter',
        marker: {
          size: 0.1,
          color: phases.map((v) => d.freq_MHz),
          coloraxis: 'coloraxis',
        },
        line: {
          color: freq_color(d.freq_MHz, {{ freq_range.min }}, {{ freq_range.max }}),
        },
      };
    });
  }

  var data = {{ data | safe }};
  var pepoch = document.getElementById('pepoch').value
  var p0     = document.getElementById('p0').value
  var p1     = document.getElementById('p1').value
  var pb     = document.getElementById('pb').value
  var dm     = document.getElementById('dm').value

  var folded_data = prepare_data(data, pepoch, p0);
  //console.log(folded_data);

  var layout = get_plotly_default_layout();
  layout.height = 100*data.length;
  layout.showlegend = false;
  layout.coloraxis = {
    cmin: {{ freq_range.min }},
    cmax: {{ freq_range.max }},
    colorbar: {
      title: {text: "Frequency (MHz)"},
      ticks: "outside",
      tickcolor: "rgb(222,226, 230)",
    },
    colorscale: Array.from({length: 11}, (_, i) => i/10).map((f) => [f, freq_color(f, 0, 1)]),
  };
  layout.xaxis = {title: {text: "Rotation phase"}};
  layout.yaxis = {title: {text: "Pulse number"}};
  //console.log(layout.coloraxis);

  // Add the pulses
  layout.shapes = [];
  data.filter((d) => (d.pulses.length > 0)).forEach((d) => {
    d.pulses.forEach((p) => {
      pulse_phase = fold(p, pepoch, p0);
      layout.shapes.push({
        type: 'rect',
        xref: 'x',
        yref: 'y',
        x0: pulse_phase.phases[0],
        x1: pulse_phase.phases[1],
        y0: d.idx,
        y1: d.idx+1,
        fillcolor: '#880',
        opacity: 0.2,
        line: {width: 0},
        visible: false, // Initialise to hidden
      });
    });
  });

  Plotly.newPlot('pulsestack', folded_data, layout);

  pulsestackDiv = document.getElementById('pulsestack');
  pulsestackDiv.on('plotly_click', function(d) {
    window.location.href = data[d.points[0].curveNumber].link;
  });

  function toggle_lightcurve_visibility(checkbox) {
    folded_data.forEach((d) => {
      d.visible = checkbox.checked;
    });
    Plotly.react('pulsestack', folded_data, layout);
  }

  function toggle_pulses_visibility(checkbox) {
    layout.shapes.forEach((s) => {
      s.visible = checkbox.checked;
    });
    Plotly.react('pulsestack', folded_data, layout);
  }

</script>

{% endblock %}
