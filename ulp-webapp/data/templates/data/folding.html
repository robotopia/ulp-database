{% extends "published/main.html" %}

{% load static %}

{% block body %}

<h1>Folding on {{ ulp }}</h1>

<h2>Working ephemeris</h2>

<form method="post" action="{% url 'update_working_ephemeris' pk=ulp.pk %}">
  {% csrf_token %}
  <div class="compact-form-item">
    <label for="pepoch">PEPOCH (MJD)</label>
    <input id="pepoch" name="pepoch" type="number" step="any" value="{{ working_ephemeris.pepoch|default_if_none:'' }}" onchange="redraw_plot();"/>
  </div>
  <div class="compact-form-item">
    <label for="p0">Rotational period (s)</label>
    <input id="p0" name="p0" type="number" step="any" value="{{ working_ephemeris.p0|default_if_none:'' }}" onchange="redraw_plot();"/>
  </div>
  <div class="compact-form-item">
    <label for="p1">Rotational period derivative (s/s)</label>
    <input id="p1" name="p1" type="number" step="any" value="{{ working_ephemeris.p1|default_if_none:'' }}" onchange="redraw_plot();"/>
  </div>
  <div class="compact-form-item">
    <label for="pb">Orbital period (h)</label>
    <input id="pb" name="pb" type="number" step="any" value="{{ working_ephemeris.pb|default_if_none:'' }}" onchange="redraw_plot();"/>
  </div>
  <div class="compact-form-item">
    <label for="dm">Dispersion measure (pc/cm^3)</label>
    <input id="dm" name="dm" type="number" step="any" value="{{ working_ephemeris.dm|default_if_none:'' }}" onchange="redraw_plot();"/>
  </div>
  <input type="submit" value="Update"/>
  <button type="button" onclick="reset_working_ephemeris(); redraw_plot();">Reset</button>
</form>

<h2>Pulsestack</h2>

<fieldset>

  <label for="xaxis">X-axis:</label>
  <select id="xaxis" name="xaxis" onchange="redraw_plot();">
    <option value="pulses_sequential" selected>Sequential pulse numbers (0, 1, 2, ...)</option>
    <option value="pulses_chronological">Chronological pulses numbers (relative to PEPOCH)</option>
    <option value="rotation_phase">Rotation phase</option>
    <option value="orbital_phase">Orbital phase</option>
    <option value="peak_Jy">Peak flux density (Jy)</option>
    <option value="frequency">Frequency</option>
  </select>

  <br>

  <label for="yaxis">Y-axis:</label>
  <select id="yaxis" name="yaxis" onchange="redraw_plot();">
    <option value="pulses_sequential">Sequential pulse numbers (0, 1, 2, ...)</option>
    <option value="pulses_chronological">Chronological pulses numbers (relative to PEPOCH)</option>
    <option value="rotation_phase" selected>Rotation phase</option>
    <option value="orbital_phase">Orbital phase</option>
    <option value="peak_Jy">Peak flux density (Jy)</option>
    <option value="frequency">Frequency (MHz)</option>
  </select>

  <br>

  <input type="checkbox" id="log_xaxis" onchange="redraw_plot();"/>
  <label for="xaxis-log">Log x-axis</label>

  <input type="checkbox" id="log_yaxis" onchange="redraw_plot();"/>
  <label for="yaxis-log">Log y-axis</label>

</fieldset>

<div id='residuals'>
</div>

<script>

  var data = {{ data | safe }};

  function prepare_data() {
    var xaxis      = document.getElementById('xaxis').value;
    var yaxis      = document.getElementById('yaxis').value;

    var pepoch = document.getElementById('pepoch').value
    var period = document.getElementById('p0').value
    var p1     = document.getElementById('p1').value
    var pb     = document.getElementById('pb').value * 3600.0; // Convert to seconds
    var dm     = document.getElementById('dm').value

    lightcurve_ctrs = fold(Array.from(data, (d) => d.mjd_ctr), pepoch, period);

    pulses_sequential = Array.from(lightcurve_ctrs.pulses, (_, i) => i);
    pulses_chronological = lightcurve_ctrs.pulses;

    freqs = Array.from(data, (d) => d.freq_MHz);

    var x, y, x_err, y_err;

    if (xaxis == 'rotation_phase') {
      x = lightcurve_ctrs.phases;
      x_err = data.map((d) => d.mjd_radius*86400/period);
    } else if (xaxis == 'orbital_phase') {
      x = fold(Array.from(data, (d) => d.mjd_ctr), pepoch, pb).phases;
      x_err = data.map((d) => d.mjd_radius*86400/pb);
    } else if (xaxis == "pulses_chronological") {
      x = pulses_chronological;
      x_err = undefined;
    } else if (xaxis == "pulses_sequential") {
      x = pulses_sequential;
      x_err = undefined;
    } else if (xaxis == "peak_Jy") {
      x = Array.from(data, (d) => d.peak_value_Jy);
      x_err = undefined;
    } else if (xaxis == "frequency") {
      x = freqs;
      x_err = undefined;
    }

    if (yaxis == 'rotation_phase') {
      y = lightcurve_ctrs.phases;
      y_err = data.map((d) => d.mjd_radius*86400/period);
    } else if (yaxis == 'orbital_phase') {
      y = fold(Array.from(data, (d) => d.mjd_ctr), pepoch, pb).phases;
      y_err = data.map((d) => d.mjd_radius*86400/pb);
    } else if (yaxis == "pulses_chronological") {
      y = pulses_chronological;
      y_err = undefined;
    } else if (yaxis == "pulses_sequential") {
      y = pulses_sequential;
      y_err = undefined;
    } else if (yaxis == "peak_Jy") {
      y = Array.from(data, (d) => d.peak_value_Jy);
      y_err = undefined;
    } else if (yaxis == "frequency") {
      y = freqs;
      y_err = undefined;
    }

    return [{
      pulses_sequential: pulses_sequential,
      pulses_chronological: pulses_chronological,
      x: x,
      y: y,
      freqs: freqs,
      error_x: {
        array: x_err,
        color: 'white',
        thickness: 1,
      },
      error_y: {
        array: y_err,
        color: 'white',
        thickness: 1,
      },
      mode: 'markers',
      type: 'scatter',
      marker: {
        size: 5,
        color: freqs,
        coloraxis: 'coloraxis',
      },
      hovertemplate: data.map((d, i) => "Ephemeris pulse #" + pulses_chronological[i] + "<br>" +
        "Date: " + d.date + "<br>" +
        "Telescope: " + d.telescope + "<br>" +
        "Frequency: " + d.freq_MHz + " MHz" +
        "<extra></extra>"),
    }];
  }

  var layout = get_plotly_default_layout();

  function update_layout() {
    layout.showlegend = false;
    layout.coloraxis = {
      cmin: {{ freq_range.min }},
      cmax: {{ freq_range.max }},
      colorbar: {
        title: {text: "Frequency (MHz)"},
        ticks: "outside",
        tickcolor: "rgb(222,226, 230)",
      },
      colorscale: Array.from({length: 11}, (_, i) => i/10).map((f) => [f, freq_color(f, 0, 1)]),
    };
    layout.yaxis = {
      title: {
        text: document.getElementById('yaxis').options[document.getElementById('yaxis').selectedIndex].text, // FIX ME!
      },
      type: document.getElementById('log_yaxis').checked ? 'log' : '-',
    };
    layout.xaxis = {
      title: {
        text: document.getElementById('xaxis').options[document.getElementById('xaxis').selectedIndex].text, // FIX ME!
      },
      type: document.getElementById('log_xaxis').checked ? 'log' : '-',
    };
    //console.log(layout.coloraxis);
  }

  console.log(data[0]);

  var folded_data;
  function redraw_plot() {
    folded_data = prepare_data();
    update_layout();
    console.log("Redrawing...");
    Plotly.react('residuals', folded_data, layout);
  }
  redraw_plot();
  //console.log(folded_data);

  /*
  // Add the pulses
  layout.shapes = [];
  data.filter((d) => (d.pulses.length > 0)).forEach((d) => {
    d.pulses.forEach((p) => {
      pulse_phase = fold(p, pepoch, p0);
      layout.shapes.push({
        type: 'rect',
        xref: 'x',
        yref: 'y',
        x0: d.idx,
        x1: d.idx + parseFloat(document.getElementById('scaleheight').value),
        y0: pulse_phase.phases[0],
        y1: pulse_phase.phases[1],
        pulse: pulse_phase.pulses[0], // Store for later, when switching stacking types
        idx: d.idx,                   // ditto
        fillcolor: '#880',
        opacity: 0.2,
        line: {width: 0},
        //visible: false, // Initialise to hidden
      });
    });
  });
  */

  residualsDiv = document.getElementById('residuals');
  residualsDiv.on('plotly_click', function(d) {
    window.location.href = data[d.points[0].pointIndex].link;
  });

  function toggle_lightcurve_visibility(checkbox) {
    folded_data.forEach((d) => {
      d.visible = checkbox.checked;
    });
    Plotly.react('residuals', folded_data, layout);
  }

  function toggle_pulses_visibility(checkbox) {
    layout.shapes.forEach((s) => {
      s.visible = checkbox.checked;
    });
    Plotly.react('residuals', folded_data, layout);
  }

  // Define behaviour of "reset working ephemeris" button
  function reset_working_ephemeris() {
    document.getElementById('pepoch').value = "{{ working_ephemeris.pepoch|default_if_none:'' }}";
    document.getElementById('p0').value = "{{ working_ephemeris.p0|default_if_none:'' }}";
    document.getElementById('p1').value = "{{ working_ephemeris.p1|default_if_none:'' }}";
    document.getElementById('pb').value = "{{ working_ephemeris.pb|default_if_none:'' }}";
    document.getElementById('dm').value = "{{ working_ephemeris.dm|default_if_none:'' }}";

    document.getElementById('pepoch').style.backgroundColor = "field";
    document.getElementById('p0').style.backgroundColor = "field";
    document.getElementById('p1').style.backgroundColor = "field";
    document.getElementById('pb').style.backgroundColor = "field";
    document.getElementById('dm').style.backgroundColor = "field";
  }

</script>

{% endblock %}
